@page "/GerarQRCode/{ReservationId}"
@using System.Globalization
@using HoteldosNobresBlazor.Classes
@using HoteldosNobresBlazor.Client.API
@using HoteldosNobresBlazor.Funcoes
@using MosaicoSolutions.ViaCep
@using MosaicoSolutions.ViaCep.Modelos
@using Newtonsoft.Json
@using System.Text.RegularExpressions
@using QRCoder
@using pix_payload_generator.net.Models.CobrancaModels
@using pix_payload_generator.net.Models.PayloadModels
@inject NavigationManager navigationManager
@inject APICloudbeds cloudbedsAPI
@inject ISnackbar Snackbar

@rendermode InteractiveAuto

<PageTitle>Reserva</PageTitle>

<MudContainer Class="px-8 pt-2 mx-4 my-4" MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4  rounded-xl" Style="height: 100%">
                <MudImage Align="Align.Center" src="@($"data:image/png;base64,{qrCode}")" Alt="QRCode" Elevation="25" Width="250" Height="250" />
                <br />
                <br />
                <MudPaper Class="rounded-xl">
                    <MudListItem style="background-color: #F5F4F4;" class="rounded-t-xl">
                        <MudStack Row="true">
                            <MudText><b>Instruções para a transferência bancária - PIX</b></MudText>
                            <MudSpacer />
                            <MudIcon Icon="fa-solid fa-building-columns" Title="Favorite" />
                        </MudStack>
                    </MudListItem>
                    <MudDivider />
                    <MudListItem>
                        <MudText Typo="Typo.caption">NÃO E POSSÍVEL PAGAR NO CHECK-IN !!!</MudText><br />
                        <br />
                        <MudText Typo="Typo.caption" GutterBottom="true" Class="ml-auto">
                            Reservas não paga no período de  30 minutos sera cancelada, como nossos Termos e Politicas.<br />
                            Pix nossa <b> CHAVE CNPJ 35.337.342/0001-86</b><br />
                            Nome <b>JOSE CARLOS NOBRE</b><br />
                            Banco SICOOB<br />
                        </MudText>
                    </MudListItem>
                </MudPaper>
                <br />
                <br />
                <MudTextField T="string" Label="Copia e Cola" @bind-Value="stringToQrCode" />
                <br />
                <br />
                <MudForm>
                    <MudList>
                        <MudListItem Avatar="@Icons.Material.Filled.Info"> Dados </MudListItem>
                        <MudTextField T="string" Label="Id Reserva" Disabled="@Disabled" @bind-Value="ReservationId" />
                        <MudTextField Disabled="@Disabled" @bind-Value="Valor" Label="Valor" Variant="Variant.Text" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AttachMoney" AdornmentColor="Color.Warning" />

                    </MudList>
                    <div class="mt-4">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="ml-auto rounded-xl"
                                   Disabled="@(!Disabled)"
                                   @onclick="Editar">
                            Editar
                        </MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Class="ml-auto rounded-xl"
                                   Disabled="@Disabled"
                                   @onclick="Salvar">
                            Salvar
                        </MudButton>
                    </div>
                </MudForm>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    [Parameter]
    public string ReservationId { get; set; }

    public Guest guest { get; set; }
    private UserInfo user = default!;

    public string Valor { get; set; }
    public string qrCode { get; set; }
    public string stringToQrCode { get; set; }

    public Reserva reserva { get; set; }

    bool ReadOnly = true;
    bool NestedReadOnly;
    bool Disabled = true;

    protected override async Task OnInitializedAsync()
    {
        qrCode = GenerateQRCode("Some data");
    }

    protected async Task Editar()
    {
        Disabled = !Disabled;
        ReadOnly = !ReadOnly;

    }

    protected async Task Salvar()
    {
        try
        {
            Cobranca cobranca = new Cobranca(_chave: "35337342000186")
                {
                    Valor = new Valor
                    {
                        Original = Valor // "0.01"
                    }
                };

            if (ReservationId is null)
                ReservationId = "Sua reserva";

            var payload = cobranca.ToPayload(ReservationId, new Merchant("HOTEL DOS NOBRES LTDA", "Pocos de Caldas"));

            stringToQrCode = payload.GenerateStringToQrCode();

            qrCode = GenerateQRCode(stringToQrCode);


            Snackbar.Add("Sucesso!", Severity.Success);

            Disabled = !Disabled;
            ReadOnly = !ReadOnly;

        }
        catch (Exception ex)
        {
            Snackbar.Add("Erro!", Severity.Error);
        }
    }

    public string GenerateQRCode(string data)
    {
        QRCodeGenerator qrGenerator = new QRCodeGenerator();
        QRCodeData qrCodeData = qrGenerator.CreateQrCode(data, QRCodeGenerator.ECCLevel.Q);
        PngByteQRCode qrCode = new PngByteQRCode(qrCodeData);
        byte[] qrCodeImage = qrCode.GetGraphic(20);
        string qrCodeAsBase64 = Convert.ToBase64String(qrCodeImage);
        return qrCodeAsBase64;
    }


} 